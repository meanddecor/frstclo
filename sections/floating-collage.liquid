{{ 'section-floating-collage.css' | asset_url | stylesheet_tag }}

<style>
  #collage-root-{{ section.id }} .centered-view-btn {
    background: {{ section.settings.button_bg_color | default: '#111111' }};
    color: {{ section.settings.button_text_color | default: '#ffffff' }};
  }
  
  #collage-root-{{ section.id }} .brutalist-img {
    max-width: {{ section.settings.image_size_desktop | default: 40 }}vw !important;
    max-height: {{ section.settings.image_size_desktop | default: 40 }}vh;
  }
  
  @media (max-width: 900px) {
    #collage-root-{{ section.id }} .brutalist-img {
      max-width: {{ section.settings.image_size_mobile | default: 60 }}vw !important;
      max-height: {{ section.settings.image_size_mobile | default: 60 }}vh;
    }
  }
</style>

<div id="collage-root-{{ section.id }}" class="floating-collage-section">
  {%- if section.settings.background_type == 'video' and section.settings.video_url != blank -%}
    <div class="video-background">
      {%- liquid
        assign video_id = section.settings.video_url.id | default: section.settings.video_url
        assign video_alt = section.settings.video_url.alt | default: section.settings.title
        assign video_poster = section.settings.video_url.preview_image | default: section.settings.video_poster
      -%}
      
      {%- if section.settings.video_url.type == 'youtube' -%}
        <iframe 
          class="video-bg"
          src="https://www.youtube.com/embed/{{ video_id }}?autoplay=1&mute=1&loop=1&playlist={{ video_id }}&controls=0&showinfo=0&rel=0&modestbranding=1"
          frameborder="0"
          allow="autoplay; encrypted-media"
          allowfullscreen>
        </iframe>
      {%- elsif section.settings.video_url.type == 'vimeo' -%}
        <iframe 
          class="video-bg"
          src="https://player.vimeo.com/video/{{ video_id }}?autoplay=1&muted=1&loop=1&background=1&controls=0"
          frameborder="0"
          allow="autoplay; fullscreen"
          allowfullscreen>
        </iframe>
      {%- else -%}
        <video class="video-bg" autoplay muted loop playsinline
          {%- if video_poster %} poster="{{ video_poster | image_url: width: 2000 }}" {%- endif -%}>
          <source src="{{ section.settings.video_url }}" type="video/mp4">
        </video>
      {%- endif -%}
      
      {%- if section.settings.video_overlay_opacity > 0 -%}
        <div class="video-overlay" style="background-color: {{ section.settings.video_overlay_color }}; opacity: {{ section.settings.video_overlay_opacity | divided_by: 100.0 }};"></div>
      {%- endif -%}
    </div>
  {%- elsif section.settings.background_type == 'image' and section.settings.background_image != blank -%}
    <div class="image-background">
      <img 
        src="{{ section.settings.background_image | image_url: width: 2000 }}"
        srcset="{{ section.settings.background_image | image_url: width: 600 }} 600w,
                {{ section.settings.background_image | image_url: width: 1200 }} 1200w,
                {{ section.settings.background_image | image_url: width: 2000 }} 2000w"
        sizes="100vw"
        alt="{{ section.settings.background_image.alt | escape }}"
        loading="lazy">
      {%- if section.settings.image_overlay_opacity > 0 -%}
        <div class="image-overlay" style="background-color: {{ section.settings.image_overlay_color }}; opacity: {{ section.settings.image_overlay_opacity | divided_by: 100.0 }};"></div>
      {%- endif -%}
    </div>
  {%- endif -%}

  <div class="brutalist-collage">
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'product' -%}
          {%- if block.settings.product != blank -%}
            {%- assign product = block.settings.product -%}
            {%- assign featured_image = product.featured_image -%}
            <div class="brutalist-img-wrapper" 
                 id="img{{ forloop.index }}-{{ section.id }}" 
                 data-link="{{ product.url }}"
                 {{ block.shopify_attributes }}>
              <img class="brutalist-img" 
                   loading="lazy" 
                   decoding="async"
                   src="{{ featured_image | image_url: width: 800 }}"
                   srcset="{{ featured_image | image_url: width: 400 }} 400w,
                           {{ featured_image | image_url: width: 600 }} 600w,
                           {{ featured_image | image_url: width: 800 }} 800w"
                   sizes="(max-width: 900px) {{ section.settings.image_size_mobile | default: 60 }}vw, {{ section.settings.image_size_desktop | default: 40 }}vw"
                   alt="{{ featured_image.alt | default: product.title | escape }}">
            </div>
          {%- endif -%}
        
        {%- when 'image' -%}
          {%- if block.settings.image != blank -%}
            <div class="brutalist-img-wrapper" 
                 id="img{{ forloop.index }}-{{ section.id }}" 
                 data-link="{{ block.settings.link }}"
                 {{ block.shopify_attributes }}>
              <img class="brutalist-img" 
                   loading="lazy" 
                   decoding="async"
                   src="{{ block.settings.image | image_url: width: 800 }}"
                   srcset="{{ block.settings.image | image_url: width: 400 }} 400w,
                           {{ block.settings.image | image_url: width: 600 }} 600w,
                           {{ block.settings.image | image_url: width: 800 }} 800w"
                   sizes="(max-width: 900px) {{ section.settings.image_size_mobile | default: 60 }}vw, {{ section.settings.image_size_desktop | default: 40 }}vw"
                   alt="{{ block.settings.image.alt | escape }}">
            </div>
          {%- endif -%}
      {%- endcase -%}
    {%- endfor -%}
  </div>
</div>

<script>
(function() {
  'use strict';
  
  const sectionId = 'collage-root-{{ section.id }}';
  const sectionElement = document.getElementById(sectionId);
  
  if (!sectionElement) return;
  
  const collageImages = Array.from(sectionElement.querySelectorAll('.brutalist-img-wrapper')).map((el, i) => ({
    id: el.id,
    src: el.querySelector('img') ? el.querySelector('img').src : '',
    link: el.getAttribute('data-link')
  }));

  const floatingState = {};
  let pausedId = null;
  let mobileCenteredId = null;
  let isVisible = false;
  let animationId = null;
  let speedMultiplier = {{ section.settings.speed_desktop | default: 0.5 }};
  let mobileSpeedMultiplier = {{ section.settings.speed_mobile | default: 0.5 }};
  let lastFrameTime = 0;

  function randomBetween(a, b) {
    return a + Math.random() * (b - a);
  }
  
  function randomDirection() {
    const angle = randomBetween(0, 2 * Math.PI);
    return { x: Math.cos(angle), y: Math.sin(angle) };
  }
  
  function createFloatingState(img, idx) {
    const isMobileDevice = window.innerWidth <= 900;
    const desktopSize = {{ section.settings.image_size_desktop | default: 40 }} / 100;
    const mobileSize = {{ section.settings.image_size_mobile | default: 60 }} / 100;
    const currentSize = isMobileDevice ? mobileSize : desktopSize;
    
    const estimatedMaxWidth = window.innerWidth * currentSize;
    const estimatedMaxHeight = window.innerHeight * currentSize;
    const maxX = Math.max(0, window.innerWidth - estimatedMaxWidth);
    const maxY = Math.max(0, window.innerHeight - estimatedMaxHeight);
    
    const cols = Math.ceil(Math.sqrt(collageImages.length));
    const zoneW = window.innerWidth / cols;
    const zoneH = window.innerHeight / cols;
    const x = Math.min((idx % cols) * zoneW + randomBetween(0, zoneW * 0.5), maxX);
    const y = Math.min(Math.floor(idx / cols) * zoneH + randomBetween(0, zoneH * 0.5), maxY);
    const speed = randomBetween(30, 80);
    const dir = randomDirection();
    
    return {
      id: img.id,
      x, y,
      dx: dir.x,
      dy: dir.y,
      speed,
      el: null,
      paused: false,
      lastTransform: '',
      link: img.link
    };
  }
  
  function animateFloatingImages(ts) {
    if (!isVisible) return;
    
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const isMobileDevice = window.innerWidth <= 900;
    
    if (isMobileDevice) {
      const mobileFrameInterval = 1000 / 45;
      if (ts - lastFrameTime < mobileFrameInterval) {
        animationId = requestAnimationFrame(animateFloatingImages);
        return;
      }
      lastFrameTime = ts;
    }
    
    Object.values(floatingState).forEach(state => {
      if (state.paused) return;
      const dt = isMobileDevice ? 1 / 45 : 1 / 60;
      const currentSpeedMultiplier = isMobileDevice ? mobileSpeedMultiplier : speedMultiplier;
      state.x += state.dx * state.speed * dt * currentSpeedMultiplier;
      state.y += state.dy * state.speed * dt * currentSpeedMultiplier;
      const el = state.el;
      const rect = el.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      
      if (isMobileDevice) {
        const offScreenBuffer = 0.5;
        const minX = -(w * offScreenBuffer);
        const maxX = vw + (w * offScreenBuffer) - w;
        const minY = -(h * offScreenBuffer);
        const maxY = vh + (h * offScreenBuffer) - h;
        
        if (state.x < minX) {
          state.x = minX;
          state.dx = Math.abs(state.dx);
        } else if (state.x > maxX) {
          state.x = maxX;
          state.dx = -Math.abs(state.dx);
        }
        if (state.y < minY) {
          state.y = minY;
          state.dy = Math.abs(state.dy);
        } else if (state.y > maxY) {
          state.y = maxY;
          state.dy = -Math.abs(state.dy);
        }
      } else {
        if (state.x < 0) {
          state.x = 0;
          state.dx = Math.abs(state.dx);
        } else if (state.x > vw - w) {
          state.x = vw - w;
          state.dx = -Math.abs(state.dx);
        }
        if (state.y < 0) {
          state.y = 0;
          state.dy = Math.abs(state.dy);
        } else if (state.y > vh - h) {
          state.y = vh - h;
          state.dy = -Math.abs(state.dy);
        }
      }

      if (mobileCenteredId !== state.id) {
        const transform = `translate(${state.x}px, ${state.y}px)`;
        if (state.lastTransform !== transform) {
          el.style.transition = '';
          el.style.transform = transform;
          state.lastTransform = transform;
        }
      }
    });
    animationId = requestAnimationFrame(animateFloatingImages);
  }
  
  function bringToFrontAndPause(id) {
    Object.values(floatingState).forEach(state => {
      if (state.id === id) {
        state.el.style.zIndex = 1;
        state.el.style.willChange = 'transform';
        state.paused = true;
      } else {
        state.el.style.zIndex = 0;
        state.el.style.willChange = 'auto';
        state.paused = false;
      }
    });
    pausedId = id;
  }
  
  function addViewButtonToCenteredImage(id, link) {
    const state = floatingState[id];
    if (!state) return;
    removeViewButton();
    if (link && link.trim() !== '') {
      const btn = document.createElement('a');
      btn.textContent = '{{ section.settings.button_text | default: "View" }}';
      btn.className = 'centered-view-btn';
      btn.href = link;
      btn.addEventListener('touchstart', e => e.stopPropagation());
      btn.addEventListener('touchend', e => e.stopPropagation());
      state.el.appendChild(btn);
    }
  }
  
  function removeViewButton() {
    sectionElement.querySelectorAll('.centered-view-btn').forEach(btn => btn.remove());
  }
  
  function isMobile() {
    return window.innerWidth <= 900;
  }
  
  function centerImageInViewport(id) {
    const state = floatingState[id];
    if (!state) return;
    const el = state.el;
    const rect = el.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const w = rect.width;
    const h = rect.height;
    const centerX = (vw - w) / 2;
    const centerY = (vh - h) / 2;
    el.style.transition = 'transform 0.5s cubic-bezier(.4,1.6,.6,1)';
    el.style.transform = `translate(${centerX}px, ${centerY}px)`;
    state.lastTransform = `translate(${centerX}px, ${centerY}px)`;
    mobileCenteredId = id;
    if (isMobile()) addViewButtonToCenteredImage(id, state.link);
  }
  
  function resumeAll() {
    Object.values(floatingState).forEach(state => {
      state.paused = false;
      state.el.style.zIndex = 0;
      state.el.style.willChange = 'auto';
      if (mobileCenteredId === state.id) {
        state.el.style.transition = 'transform 0.5s cubic-bezier(.4,1.6,.6,1)';
        state.el.style.transform = `translate(${state.x}px, ${state.y}px)`;
        state.lastTransform = `translate(${state.x}px, ${state.y}px)`;
      }
    });
    removeViewButton();
    mobileCenteredId = null;
    pausedId = null;
  }
  
  function setupInteraction() {
    Object.values(floatingState).forEach(state => {
      state.el.onclick = function(e) {
        if (!isMobile() && state.link) {
          window.location.href = state.link;
        }
      };
      state.el.onmouseenter = () => {
        if (!isMobile()) bringToFrontAndPause(state.id);
      };
      state.el.onmouseleave = () => {
        if (!isMobile()) resumeAll();
      };
      state.el.addEventListener('touchstart', e => {
        e.stopPropagation();
        bringToFrontAndPause(state.id);
        if (isMobile()) centerImageInViewport(state.id);
      }, { passive: false });
    });
    
    sectionElement.addEventListener('touchstart', function(e) {
      if (e.target.classList.contains('centered-view-btn')) return;
      if (e.target.classList.contains('brutalist-img')) return;
      if (pausedId) resumeAll();
    }, { passive: true });
  }
  
  function setupIntersectionObserver() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          isVisible = true;
          if (!animationId) {
            animateFloatingImages();
          }
        } else {
          isVisible = false;
          if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '50px'
    });
    
    if (sectionElement) {
      observer.observe(sectionElement);
    }
  }
  
  function initFloatingCollage() {
    collageImages.forEach((img, i) => {
      floatingState[img.id] = createFloatingState(img, i);
      floatingState[img.id].el = sectionElement.querySelector('#' + img.id);
      if (floatingState[img.id].el) {
        const state = floatingState[img.id];
        state.el.style.zIndex = 0;
        state.el.style.transform = `translate(${state.x}px, ${state.y}px)`;
        state.lastTransform = `translate(${state.x}px, ${state.y}px)`;
        setTimeout(() => {
          state.el.classList.add('initialized');
        }, 50 + i * 50);
      }
    });
    
    setupIntersectionObserver();
    
    setTimeout(() => {
      setupInteraction();
      const rect = sectionElement.getBoundingClientRect();
      const initiallyVisible = rect.top < window.innerHeight && rect.bottom > 0;
      
      if (isVisible || initiallyVisible) {
        isVisible = true;
        animateFloatingImages();
      }
    }, 100);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFloatingCollage);
  } else {
    initFloatingCollage();
  }
  
  window.addEventListener('resize', () => {
    Object.values(floatingState).forEach((state, i) => {
      const isMobileDevice = window.innerWidth <= 900;
      const desktopSize = {{ section.settings.image_size_desktop | default: 40 }} / 100;
      const mobileSize = {{ section.settings.image_size_mobile | default: 60 }} / 100;
      const currentSize = isMobileDevice ? mobileSize : desktopSize;
      const estimatedMaxWidth = window.innerWidth * currentSize;
      const estimatedMaxHeight = window.innerHeight * currentSize;
      const maxX = Math.max(0, window.innerWidth - estimatedMaxWidth);
      const maxY = Math.max(0, window.innerHeight - estimatedMaxHeight);
      state.x = Math.min(state.x, maxX);
      state.y = Math.min(state.y, maxY);
      if (mobileCenteredId === state.id && isMobile()) {
        centerImageInViewport(state.id);
      }
    });
  });
})();
</script>

{% schema %}
{
  "name": "Floating Collage",
  "tag": "section",
  "class": "section-floating-collage",
  "settings": [
    {
      "type": "header",
      "content": "Background Settings"
    },
    {
      "type": "select",
      "id": "background_type",
      "label": "Background Type",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "video",
          "label": "Video"
        },
        {
          "value": "image",
          "label": "Image"
        }
      ],
      "default": "none"
    },
    {
      "type": "video_url",
      "id": "video_url",
      "label": "Video URL",
      "info": "Upload a video or paste a YouTube/Vimeo URL",
      "accept": ["youtube", "vimeo"]
    },
    {
      "type": "image_picker",
      "id": "video_poster",
      "label": "Video Poster Image",
      "info": "Shown before video loads"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },
    {
      "type": "color",
      "id": "video_overlay_color",
      "label": "Video Overlay Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "video_overlay_opacity",
      "label": "Video Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 0
    },
    {
      "type": "color",
      "id": "image_overlay_color",
      "label": "Image Overlay Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "image_overlay_opacity",
      "label": "Image Overlay Opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 0
    },
    {
      "type": "header",
      "content": "Animation Settings"
    },
    {
      "type": "range",
      "id": "speed_desktop",
      "label": "Speed (Desktop)",
      "min": 0.1,
      "max": 2,
      "step": 0.1,
      "default": 0.5
    },
    {
      "type": "range",
      "id": "speed_mobile",
      "label": "Speed (Mobile)",
      "min": 0.1,
      "max": 2,
      "step": 0.1,
      "default": 0.5
    },
    {
      "type": "range",
      "id": "image_size_desktop",
      "label": "Image Size Desktop (vw)",
      "min": 20,
      "max": 60,
      "step": 5,
      "unit": "vw",
      "default": 40
    },
    {
      "type": "range",
      "id": "image_size_mobile",
      "label": "Image Size Mobile (vw)",
      "min": 40,
      "max": 90,
      "step": 5,
      "unit": "vw",
      "default": 60
    },
    {
      "type": "header",
      "content": "Button Settings"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text (Mobile)",
      "default": "View"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Button Background",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        }
      ]
    },
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Floating Collage",
      "blocks": [
        {
          "type": "product"
        },
        {
          "type": "product"
        },
        {
          "type": "product"
        }
      ]
    }
  ]
}
{% endschema %}
